# 提示词变量汇总（ConversationFlow v2）

本文档汇总系统内置的提示词模板（PromptTemplate）以及每个模板会被渲染替换的变量（`{{...}}`）。模板由初始化脚本写入数据库并启用：见 [init_database.py](file:///c:/Users/yichu/Desktop/ai_assistant/test/init_database.py)。

## 约定与渲染方式

- 模板存储字段：
  - `scene`：模板标识（如 `normal_tool_select`、`agent_answer`）。
  - `system_prompt`：系统提示词（通常不需要变量）。
  - `user_prompt_template`：用户提示词模板（包含 `{{变量}}` 占位符）。
- 渲染规则：
  - 运行时由业务代码将 `user_prompt_template` 中的 `{{变量}}` 替换为实际值。
  - 所有变量建议以字符串渲染，避免 `None`。
  - 复杂对象（tools/tool_events/self_check）建议渲染为 pretty JSON 字符串，便于模型引用与自检。
  - `{{question}}` 来自用户原问题的清洗版（question_clean）：会自动剔除前端控制字段/工具开关描述等噪声，便于首轮检索。

## 模板清单（v2）

当前初始化会写入并启用以下模板（v2）：

- `normal_tool_select`：normal 模式工具选择（严格 JSON）
- `normal`：normal 模式最终回答（自然语言）
- `agent_tool_select`：agent 模式工具选择（严格 JSON）
- `agent_answer`：agent 草稿回答（自然语言）
- `agent_self_check`：agent 自检（严格 JSON）
- `agent_tool_retry`：agent 重试工具选择（严格 JSON）
- `agent_final`：agent 最终回答（自然语言）

兼容模板（v2 仍会写入，供旧代码回退/兼容）：
- `agent_router`：等价于 `agent_tool_select`
- `agent_retry`：等价于 `agent_tool_retry`

---

## normal_tool_select

**用途**
- normal 模式的工具选择阶段：根据 `question/context/tools` 决定是否调用工具与调用哪些工具。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 最近对话上下文 | 文本块（role: content） |
| `{{tools}}` | 是 | 可用工具列表 | JSON 字符串（工具名/描述/schema） |

**输出要求（严格 JSON）**
```json
{
  "action": "ok|clarify",
  "clarify_questions": ["..."],
  "tool_calls": [{"name": "工具名", "payload": {}}]
}
```

---

## normal

**用途**
- normal 模式最终回答：基于 `context` 与工具执行结果 `tool_events` 回答用户问题。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 最近对话上下文 | 文本块 |
| `{{tool_events}}` | 否 | 工具调用事件列表 | JSON 字符串（含 tool_out/elapsed_ms） |

**输出要求**
- 自然语言中文回答（无 JSON 约束）

---

## agent_tool_select

**用途**
- agent 模式工具选择：根据 `question/context/tools` 输出本轮 tool_calls（严格 JSON）。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 最近对话上下文（更长） | 文本块 |
| `{{tools}}` | 是 | 可用工具列表 | JSON 字符串 |

**输出要求（严格 JSON）**
```json
{
  "action": "ok|clarify",
  "clarify_questions": ["..."],
  "tool_calls": [{"name": "工具名", "payload": {}}]
}
```

---

## agent_answer

**用途**
- agent 草稿回答：基于 `context + tool_events` 给出草稿答复（不要求 JSON）。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 最近对话上下文 | 文本块 |
| `{{tool_events}}` | 否 | 工具调用事件列表 | JSON 字符串 |

**输出要求**
- 自然语言中文回答（建议：结论 → 要点 → 依据/来源）

---

## agent_self_check

**用途**
- agent 自检：判断 `draft_answer` 是否相关、是否有依据、是否需要重试（严格 JSON）。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 上下文约束（可包含“必须触发 retry/不许用工具”等） | 文本块 |
| `{{draft_answer}}` | 是 | 草稿回答 | 完整文本 |
| `{{tool_events}}` | 否 | 工具调用事件列表 | JSON 字符串 |

**输出要求（严格 JSON）**
```json
{
  "relevant": true,
  "grounded": true,
  "retry": false,
  "critique": "..."
}
```

---

## agent_tool_retry

**用途**
- agent 重试策略：根据 `self_check` 与工具列表，生成下一轮 tool_calls（严格 JSON）。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{context}}` | 否 | 上下文约束 | 文本块 |
| `{{self_check}}` | 是 | 自检 JSON | JSON 字符串 |
| `{{tools}}` | 是 | 可用工具列表 | JSON 字符串 |

**输出要求（严格 JSON）**
```json
{
  "tool_calls": [{"name": "工具名", "payload": {}}]
}
```

---

## agent_final

**用途**
- agent 最终回答：结合 `best_answer + evidence` 输出最终答复（自然语言）。

**变量**
| 变量 | 必填 | 含义 | 建议格式 |
|---|---:|---|---|
| `{{question}}` | 是 | 用户问题 | 原始用户输入 |
| `{{best_answer}}` | 是 | 最佳草稿回答 | 完整文本 |
| `{{evidence}}` | 否 | 证据汇总（通常来自工具事件 JSON） | 文本/JSON 字符串 |

**输出要求**
- 自然语言中文回答（无 JSON 约束）

