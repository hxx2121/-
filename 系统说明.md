# 系统说明（编程问答系统：Django + Vue3）

## 1. 系统概述

本系统提供“编程问题问答 + 会话式对话 + 数据集检索推荐 + 答案质量评估 + 提示词模板管理”的一体化能力。

- 后端以 Django + DRF 提供统一风格的 JSON API
- 前端以 Vue3 + Vite 实现登录、聊天、数据集浏览与后台管理页面
- 核心问答能力由大模型（当前实现：通义千问 Qwen，OpenAI 兼容接口）驱动，并结合本地 StackOverflow 清洗问答数据进行相似检索辅助生成

## 2. 技术栈与依赖

### 2.1 后端

- Django 5.2
- djangorestframework
- TokenAuthentication
- openai Python SDK（以 OpenAI 兼容协议调用 Qwen）
- httpx（OpenAI SDK 的 http_client）
- scikit-learn（TF-IDF + cosine 相似度）
- joblib（检索索引缓存）
- pylint（代码静态分析评分）

依赖清单见：`requirements.txt`

### 2.2 前端

- Vue 3 + TypeScript
- Vite
- Pinia、Vue Router

依赖清单见：`ui/package.json`

## 3. 总体架构

- 路由入口：QA 模块挂载在 `/api/qa/`，认证模块挂载在 `/api/auth/`
- 统一返回结构：所有接口返回 `{ code, msg, data }`
- 权限控制：
  - 大部分 QA 接口需登录
  - 管理接口需管理员权限

## 4. 数据模型（django_qa）

### 4.1 PromptTemplate（提示词模板）

- scene：场景标识（例如 `cot_programming`）
- version：版本号
- system_prompt：系统提示词
- user_prompt_template：用户提示词模板（支持 `{{question}}`、`{{context}}`）
- is_active：是否启用

### 4.2 ConversationThread（会话线程）

- owner：所属用户
- title：标题
- created_at / updated_at：创建与更新时间

### 4.3 ConversationMessage（会话消息）

- thread：所属会话线程
- role：`user` / `assistant`
- content：消息内容
- citations_json：引用（相似问答的引用与推荐）
- tool_events_json：工具调用事件（例如检索耗时、是否成功等）

### 4.4 AnswerEvaluation（回答质量评估）

对 `assistant` 消息进行评分并落库：

- syntax_score：语法分
- logic_score：逻辑分
- utility_score：通用性分
- readability_score：可读性分
- total_score：总分
- analysis_report：简要报告

### 4.5 ProgrammingQAPair（清洗后的问答对）

存储清洗后的 StackOverflow 问答对，用于数据集浏览与检索辅助：

- question_id / answer_id、title
- question_body / answer_body、tags_json
- question_score / answer_score、view_count
- question_creation_date / answer_creation_date
- question_code_snippets_json / answer_code_snippets_json

## 5. 核心模块说明

### 5.1 大模型调用（django_qa/utils/llm.py）

- 通过 `CURRENT_LLM_MODEL` 选择模型；当前仅实现 `qwen`
- Qwen 通过 OpenAI 兼容接口调用：
  - `QWEN_API_KEY`
  - `QWEN_API_BASE`
  - `QWEN_MODEL_NAME`

### 5.2 提示词渲染（django_qa/utils/prompt.py）

使用简单字符串替换渲染模板变量：

- `{{question}}`：用户问题
- `{{context}}`：上下文（会话上下文 + 检索上下文）

### 5.3 相似检索与推荐（django_qa/utils/qa_match.py）

- 数据源：`data/stackoverflow-python-qa-cleaned.jsonl`
- 索引：TF-IDF 向量化后使用 cosine 相似度检索
- 缓存：索引缓存到 `output/qa_index/index.joblib`
- 输出两类结果：
  - `matches`：相似问题列表（以相似度排序）
  - `recommendations`：融合相似度 + 代码质量 + 赞数的推荐结果

### 5.4 答案质量评估（django_qa/utils/code_analysis.py）

- 从回答文本中抽取代码块（Markdown fenced code、HTML code、缩进代码）
- 对代码块进行 AST 解析，计算语法分
- 运行 pylint，计算可读性分
- 通过启发式规则计算通用性分
- 加权融合得到总分与报告

## 6. API 设计（django_qa）

所有接口以 `/api/qa/` 为前缀。

### 6.1 单轮问答

- `POST /api/qa/qa/`
- 入参：`{ "question": "...", "prompt_scene": "cot_programming"(可选) }`
- 出参：`{ answer, evaluation }`
- 失败：模型调用失败返回 HTTP 502，业务码 `50201`

### 6.2 会话线程

- `GET /api/qa/threads/`：列出当前用户线程
- `POST /api/qa/threads/`：创建线程
- `DELETE /api/qa/threads/{thread_id}/`：删除线程（本人或管理员）

### 6.3 会话消息

- `GET /api/qa/threads/{thread_id}/messages/`：拉取消息
- `POST /api/qa/threads/{thread_id}/messages/`：发送消息并生成 assistant 回复

生成流程（简化）：

1. 写入用户消息
2. 汇总最近消息作为会话上下文
3. 相似检索并拼接“相似问答检索结果（供参考）”作为额外上下文
4. 渲染提示词并调用大模型生成回答
5. 写入 assistant 消息（含 citations/tool_events）
6. 对回答进行质量评估并落库

### 6.4 提示词模板管理（管理员）

- `GET/POST /api/qa/admin/prompts/`
- `PATCH/DELETE /api/qa/admin/prompts/{prompt_id}/`

### 6.5 质量指标（管理员）

- `GET /api/qa/admin/answer-metrics/`
- 返回均分、质量分布、近 7 日活跃等统计

### 6.6 数据集浏览

- `GET /api/qa/dataset/summary/`：总量、Top tags、Top pairs
- `GET /api/qa/dataset/pairs/?q=&tag=&sort=&page=&page_size=`：分页筛选
- `GET /api/qa/dataset/pairs/{pair_id}/`：详情

## 7. 配置项与数据文件

### 7.1 环境变量（建议写入项目根目录 .env）

- Django：
  - `DJANGO_SECRET_KEY`
  - `DJANGO_DEBUG`
  - `DJANGO_ALLOWED_HOSTS`
- 数据库：
  - `DJANGO_DB_ENGINE`（`sqlite3` 或 `mysql`）
  - MySQL 时：`MYSQL_DATABASE`、`MYSQL_USER`、`MYSQL_PASSWORD`、`MYSQL_HOST`、`MYSQL_PORT`
- 模型选择：
  - `CURRENT_LLM_MODEL`（当前仅支持 `qwen`）
- Qwen：
  - `QWEN_API_KEY`
  - `QWEN_API_BASE`
  - `QWEN_MODEL_NAME`

### 7.2 数据文件

- 清洗问答数据：`data/stackoverflow-python-qa-cleaned.jsonl`
- 索引缓存：`output/qa_index/index.joblib`

## 8. 初始化与运行（建议流程）

### 8.1 后端

1. 安装依赖
   - `pip install -r requirements.txt`
2. 数据库迁移
   - `python manage.py migrate`
3. （可选）导入清洗问答对到数据库
   - `python manage.py import_cleaned_qa --path data/stackoverflow-python-qa-cleaned.jsonl`
4. 启动服务
   - `python manage.py runserver`

### 8.2 前端

1. 安装依赖
   - `cd ui && npm install`
2. 启动开发服务器
   - `npm run dev`

### 8.3 认证方式

后端使用 DRF TokenAuthentication；前端请求一般携带：

- `Authorization: Token <token>`

